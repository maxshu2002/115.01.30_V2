<!doctype html>
<html lang="zh-Hant">
<head>
<!-- é è¦½é€£çµé¡¯ç¤ºè¨­å®šï¼ˆLINE / FB / Discord / IG ç­‰ï¼‰ -->
<meta property="og:title" content="ç”²ä½£è©¦ç®—ä¸€è¦½è¡¨" />
<meta property="og:description" content="è£½ä½œè€…ï¼šå¾æ°ã€€v115.01.30xï¼ˆä¿®æ­£ç‰ˆï¼‰ï¼ˆä¿®æ­£ç‰ˆï¼‰<br>
ç”²ä½£æ¯”ç‡è«‹ä»¥æœ€æ–°å…¬å‘Šä¹‹å…¬æ–‡ç‚ºä¸»<br>
ï¼ˆæœ¬ç¶²é åƒ…ä¾›åƒè€ƒï¼‰xï¼ˆä¿®æ­£ç‰ˆï¼‰ã€€ç”²ä½£æ¯”ç‡è«‹ä»¥æœ€æ–°å…¬å‘Šä¹‹å…¬æ–‡ç‚ºä¸»ï¼ˆæœ¬ç¶²é åƒ…ä¾›åƒè€ƒï¼‰" />
<meta property="og:image" content="https://jj-post.github.io/insurance-commission_V2/icon-512.png" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://jj-post.github.io/insurance-commission_V2/" />
<meta name="twitter:card" content="summary_large_image" />

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ç”²ä½£ä¸€è¦½è¡¨ï¼ˆå¡ç‰‡ç‰ˆï¼‰â€” ä¿®æ­£ç‰ˆ</title>
<style>
:root{ --bg:#0b1220; --panel:#0b1326; --line:rgba(255,255,255,.08); --muted:#94a3b8; }
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:#e2e8f0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans TC,Helvetica,Arial,sans-serif}
.container{max-width:960px;margin:0 auto;padding:14px;}
h1{font-weight:800;margin:6px 0 2px}
.muted{color:var(--muted)}
.group{border:1px solid var(--line);border-radius:14px;margin:10px 0;background:var(--panel)}
.group-header{display:flex;gap:10px;align-items:center;padding:12px 14px;cursor:pointer}
.group-header .chev{margin-right:2px}
.group-title{font-weight:700}
.group-sub{font-size:12px;color:var(--muted);margin-left:8px}
.count-toggle{margin-left:auto;cursor:pointer;color:var(--muted)}
.hide{display:none}
.sublist{padding:8px 0;border-top:1px solid var(--line)}
.subitem{display:block;width:100%;text-align:left;padding:10px 14px;background:none;border:none;color:#e2e8f0;font-size:15px}
.subitem:active{opacity:.85}
.card{margin:8px 12px 14px;border:1px solid var(--line);border-radius:14px;background:#0b1326;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
.badge{padding:2px 8px;border:1px solid rgba(255,215,0,.5);border-radius:999px;font-size:12px;color:#facc15}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
input.num{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0a1428;color:#e2e8f0;font-size:16px}
.footer-note{text-align:center;color:var(--muted);font-size:12px;margin-top:10px}
.pos{color:#22c55e !important;}
.badge{white-space:nowrap;}
</style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1220">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="icon-192.png">

</head>
<body>
<div class="container">
  <h1>ç”²ä½£è©¦ç®—ä¸€è¦½è¡¨</h1>
  <div class="muted" style="font-size:12px;opacity:.85;margin-top:2px;">
    è£½ä½œè€…ï¼šå¾æ°ã€€v115.01.30xï¼ˆä¿®æ­£ç‰ˆï¼‰ï¼ˆä¿®æ­£ç‰ˆï¼‰<br>
ç”²ä½£æ¯”ç‡è«‹ä»¥æœ€æ–°å…¬å‘Šä¹‹å…¬æ–‡ç‚ºä¸»<br>
ï¼ˆæœ¬ç¶²é åƒ…ä¾›åƒè€ƒï¼‰
  </div>
  
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:6px;">
    <div id="counterBox" class="muted" style="font-size:12px;">
      ğŸ‘ï¸ ç´¯è¨ˆç€è¦½ï¼š<span id="visitTotal">â€”</span><span id="visitUpdatedWrap" style="display:none;">ï¼ˆæ›´æ–°ï¼š<span id="visitUpdated">â€”</span>ï¼‰</span>
    </div>
    <button id="btnAdmin" style="border:1px solid var(--line);background:var(--panel);color:#e2e8f0;border-radius:10px;padding:6px 12px;cursor:pointer">ç®¡ç†</button>
  </div>
<div id="app"></div>
  <div class="footer-note">å¡ç‰‡ç‰ˆãƒ»æ¯æ¬¡é–‹å•Ÿçš†åˆå§‹åŒ–ï¼ˆä¸æ¸…ç©ºè¨­å®šï¼‰ãƒ»å¯åŠ å…¥ä¸»ç•«é¢é›¢ç·šä½¿ç”¨ã€€âš ï¸ åƒ…ä¾›å…§éƒ¨åŒä»åƒè€ƒä½¿ç”¨</div>
</div>

<script>
const GROUPS = [
  { key:'å®ˆè­·å°é¡çµ‚èº«', sub:'W20 / W21 / W22 / W23', items:[
      {name:'å®ˆè­·å°é¡çµ‚èº« W20ï¼ˆ6å¹´æœŸï¼‰', monthly:0, rate:'4.2%'},
      {name:'å®ˆè­·å°é¡çµ‚èº« W21ï¼ˆ10å¹´æœŸï¼‰', monthly:0, rate:'8.8%'},
      {name:'å®ˆè­·å°é¡çµ‚èº« W22ï¼ˆ15å¹´æœŸï¼‰', monthly:0, rate:'12.8%'},
      {name:'å®ˆè­·å°é¡çµ‚èº« W23ï¼ˆ20å¹´æœŸï¼‰', monthly:0, rate:'16.8%'},
  ]},
  { key:'é‡‘æ»¿æº¢', sub:'E13 / E14', items:[
      {name:'é‡‘æ»¿æº¢ E13ï¼ˆ2å¹´æœŸ/ä¿é¡10-29è¬ï¼‰', monthly:0, rate:'0.50%', payout:[0.5, 0.5]},
      {name:'é‡‘æ»¿æº¢ E13ï¼ˆ2å¹´æœŸ/ä¿é¡30-50è¬ï¼‰', monthly:0, rate:'1.88%', payout:[0.5, 0.5]},
      {name:'é‡‘æ»¿æº¢ E14ï¼ˆ6å¹´æœŸ/ä¿é¡10-29è¬ï¼‰', monthly:0, rate:'0.58%', payout:[0.5, 0.3, 0.2]},
      {name:'é‡‘æ»¿æº¢ E14ï¼ˆ6å¹´æœŸ/ä¿é¡30-50è¬ï¼‰', monthly:0, rate:'2.00%', payout:[0.5, 0.3, 0.2]},
  ]},
  { key:'å¹´å¹´å¸¸æ˜¥', sub:'I26 / I27', items:[
      {name:'å¹´å¹´å¸¸æ˜¥ I26ï¼ˆ6å¹´æœŸ/ä¿é¡10-29è¬ï¼‰', monthly:0, rate:'2.08%'},
      {name:'å¹´å¹´å¸¸æ˜¥ I26ï¼ˆ6å¹´æœŸ/ä¿é¡30-49è¬ï¼‰', monthly:0, rate:'2.18%'},
      {name:'å¹´å¹´å¸¸æ˜¥ I26ï¼ˆ6å¹´æœŸ/ä¿é¡50è¬ä»¥ä¸Šï¼‰', monthly:0, rate:'2.38%'},
      {name:'å¹´å¹´å¸¸æ˜¥ I27ï¼ˆ10å¹´æœŸ/ä¿é¡10-29è¬ï¼‰', monthly:0, rate:'3.78%'},
      {name:'å¹´å¹´å¸¸æ˜¥ I27ï¼ˆ10å¹´æœŸ/ä¿é¡30-49è¬ï¼‰', monthly:0, rate:'3.88%'},
      {name:'å¹´å¹´å¸¸æ˜¥ I27ï¼ˆ10å¹´æœŸ/ä¿é¡50è¬ä»¥ä¸Šï¼‰', monthly:0, rate:'4.08%'},
  ]},
  { key:'å¥½å‰åˆ©', sub:'E12ï¼ˆ8å¹´æœŸï¼‰', items:[
      {name:'å¥½å‰åˆ© E12ï¼ˆ8å¹´æœŸ/ä¿é¡10-29è¬ï¼‰', monthly:0, rate:'2.5%'},
      {name:'å¥½å‰åˆ© E12ï¼ˆ8å¹´æœŸ/ä¿é¡30-49è¬ï¼‰', monthly:0, rate:'2.8%'},
      {name:'å¥½å‰åˆ© E12ï¼ˆ8å¹´æœŸ/ä¿é¡50è¬ä»¥ä¸Šï¼‰', monthly:0, rate:'3.0%'},
  ]},
  { key:'çæ„› 015', sub:'E10 / E11', items:[
      {name:'çæ„› 015 E10ï¼ˆ6å¹´æœŸ/ä¿é¡10-29è¬ï¼‰', monthly:0, rate:'1.68%'},
      {name:'çæ„› 015 E10ï¼ˆ6å¹´æœŸ/ä¿é¡30-49è¬ï¼‰', monthly:0, rate:'1.88%'},
      {name:'çæ„› 015 E10ï¼ˆ6å¹´æœŸ/ä¿é¡50è¬ä»¥ä¸Šï¼‰', monthly:0, rate:'2.28%'},
      {name:'çæ„› 015 E11ï¼ˆ10å¹´æœŸ/ä¿é¡10-29è¬ï¼‰', monthly:0, rate:'3.28%'},
      {name:'çæ„› 015 E11ï¼ˆ10å¹´æœŸ/ä¿é¡30-49è¬ï¼‰', monthly:0, rate:'3.58%'},
      {name:'çæ„› 015 E11ï¼ˆ10å¹´æœŸ/ä¿é¡50è¬ä»¥ä¸Šï¼‰', monthly:0, rate:'3.98%'},
  ]},
  { key:'å¸¸é´»å¢é¡', sub:'I24 / I25', items:[
      {name:'å¸¸é´»å¢é¡ I24ï¼ˆ6å¹´æœŸ/ä¿é¡10-29è¬ï¼‰', monthly:0, rate:'2.28%'},
      {name:'å¸¸é´»å¢é¡ I24ï¼ˆ6å¹´æœŸ/ä¿é¡30-49è¬ï¼‰', monthly:0, rate:'2.38%'},
      {name:'å¸¸é´»å¢é¡ I24ï¼ˆ6å¹´æœŸ/ä¿é¡50è¬ä»¥ä¸Šï¼‰', monthly:0, rate:'2.68%'},
      {name:'å¸¸é´»å¢é¡ I25ï¼ˆ10å¹´æœŸ/ä¿é¡10-29è¬ï¼‰', monthly:0, rate:'4.08%'},
      {name:'å¸¸é´»å¢é¡ I25ï¼ˆ10å¹´æœŸ/ä¿é¡30-49è¬ï¼‰', monthly:0, rate:'4.38%'},
      {name:'å¸¸é´»å¢é¡ I25ï¼ˆ10å¹´æœŸ/ä¿é¡50è¬ä»¥ä¸Šï¼‰', monthly:0, rate:'4.58%'},
  ]},
];

function parseRate(r){
  if(!r) return 0;
  r = (''+r).replace(/,/g,'').trim();
  if(r.endsWith('%')) return parseFloat(r)/100;
  const v = parseFloat(r);
  if (isNaN(v)) return 0;
  return v>1 ? v/100 : v;
}
function fmt(n){ if(!isFinite(n)) return '0'; return Math.round(n).toString(); }
function fmtMoney(n){ try{ return Math.round(n).toLocaleString('zh-Hant-TW') + ' å…ƒ'; }catch(e){ return fmt(n) + ' å…ƒ'; } }

const app = document.getElementById('app');
function buildCard({name, rate, payout}){
  const rows = payout.map((p,i)=>{
    const nth = i+1;
    const percent = Math.round(p*100);
    return `<div class="muted" style="font-size:13px;">ç¬¬${nth}å¹´ (${percent}%)</div><div class="pos" id="y${nth}" style="text-align:right;font-weight:700;">0</div>`;
  }).join('');
  const totalRow = `<div class="muted" style="font-size:13px;">åˆè¨ˆ</div><div id="total" style="text-align:right;font-weight:800;font-size:18px;" class="pos">0</div>`;

  const host = document.createElement('div');
  host.className = 'card';
  host.innerHTML = `
    <div style="font-weight:700;margin-bottom:8px;display:flex;gap:8px;align-items:center;justify-content:space-between;">
      <div><span class="badge">ç”²ä½£è©¦ç®—</span> <span>${name}</span></div>
      <button class="close-card" style="background:none;border:1px solid rgba(255,255,255,.15);color:#e2e8f0;border-radius:8px;padding:4px 8px;font-size:12px;">æ”¶èµ·</button>
    </div>
    <div class="row" style="gap:12px;margin-bottom:6px;">
      <div class="muted">ç”²ä½£æ¯”ç‡</div><div style="font-weight:600;">${(rate*100).toFixed(2).replace(/\.00$/,'')}%</div>
    </div>
    <div style="margin-top:6px;">
      <label class="muted" style="font-size:13px;display:block;margin-bottom:4px;">è¼¸å…¥ä¿è²»ï¼ˆæœˆç¹³ï¼‰</label>
      <input class="num" id="monthly" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="è«‹è¼¸å…¥æœˆä¿è²»">
    </div>
    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      ${rows}
      ${totalRow}
    </div>
  `;
  const inp = host.querySelector('#monthly');
  const total = host.querySelector('#total');
  const yCells = payout.map((_,i)=>host.querySelector('#y'+(i+1)));
  function recalc(){
    const m = parseFloat((inp.value||'0').replace(/,/g,''))||0;
    const base = m * 12 * rate;
    let sum = 0;
    payout.forEach((p,i)=>{
      const v = base * p;
      sum += v;
      if(yCells[i]) yCells[i].textContent = fmtMoney(v);
    });
    total.textContent = fmtMoney(sum);
  }
  inp.addEventListener('input', function(ev){
    const raw = (inp.value||'').replace(/,/g,'').replace(/[^\d.]/g,'');
    inp.value = raw;
    queueMicrotask(()=>{
      const n = raw ? Math.round(parseFloat(raw)) : 0;
      inp.value = n ? n.toLocaleString('zh-Hant-TW') : '';
      recalc();
    });
  });
  host.addEventListener('click', function(e){
    if(e.target && e.target.classList.contains('close-card')){
      host.remove();
    }
  });
  recalc();
  return host;
}

// ====== Admin storage keys ======
const DEFAULT_ADMIN_PWD = 'admin123';
const PWD_KEY = 'adminPwd_v114_10_20';
const CFG_KEY = 'customProducts_v114_10_20'; // per-device overrides
const COUNTER_URL_KEY = 'counterURL_v114_10_20';
const CFG_VERSION_KEY = 'customProductsVersion_v114_10_20';
const REMOTE_CFG_URL_KEY = 'remoteCfgURL_v114_10_20';

function getPwd(){ return localStorage.getItem(PWD_KEY) || DEFAULT_ADMIN_PWD; }
function setPwd(p){ localStorage.setItem(PWD_KEY, p); }

function loadCustom(){
  try{ return JSON.parse(localStorage.getItem(CFG_KEY) || '{"groups":[]}'); }
  catch(e){ return {groups:[]}; }
}
function saveCustom(cfg){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }

// Merge default GROUPS with custom overrides
function mergeGroups(defaults, custom){
  const byKey = new Map(defaults.map(g=>[g.key, JSON.parse(JSON.stringify(g))]));
  (custom.groups||[]).forEach(cg=>{
    if(!byKey.has(cg.key)){
      byKey.set(cg.key, {key:cg.key, sub: cg.sub||'', items: []});
    }
    const base = byKey.get(cg.key);
    const dict = new Map((base.items||[]).map(i=>[i.name, i]));
    (cg.items||[]).forEach(ci=>{
      const ex = dict.get(ci.name) || {name:ci.name, monthly:0, rate:'0%', payout:'0.5,0.3,0.2', enabled:true};
      dict.set(ci.name, {...ex, ...ci});
    });
    base.items = Array.from(dict.values());
  });
  byKey.forEach(g=>{ g.items.forEach(i=>{ if(i.enabled===undefined) i.enabled = true; }); });
  return Array.from(byKey.values());
}

// ===== Front render (uses merged + enabled filter) =====
function render(){
  const cfg = loadCustom();
  const merged = mergeGroups(GROUPS, cfg);
  app.innerHTML = '';
  merged.forEach(group => {
    const wrap = document.createElement('div');
    wrap.className = 'group';
    const header = document.createElement('div');
    header.className = 'group-header';
    const sub = group.sub ? `<span class="group-sub">${group.sub}</span>` : '';
    const itemsEnabled = (group.items||[]).filter(i=>i.enabled!==false);
    // æ–°å¢ï¼šè‹¥ç„¡å¯ç”¨å•†å“ï¼Œå‰å°ä¸é¡¯ç¤ºæ­¤ç¾¤çµ„
    if(itemsEnabled.length === 0){ return; }
    header.innerHTML = `<span class="chev">â–¸</span><span class="group-title">${group.key}</span>${sub}<span class="count-toggle">${itemsEnabled.length} ç­† â–¾</span>`;
    wrap.appendChild(header);

    const sublist = document.createElement('div');
    sublist.className = 'sublist hide';
    sublist.innerHTML = itemsEnabled.map(it => {
      const short = it.name.replace(group.key,'').trim();
      return `<button class="subitem" data-name="${it.name}" data-rate="${it.rate||''}" data-payout="${(it.payout||'0.5,0.3,0.2')}"><span style="color:var(--muted)">&emsp;${group.key}</span> ${short}</button>`;
    }).join('');
    wrap.appendChild(sublist);

    const cardHost = document.createElement('div');
    wrap.appendChild(cardHost);

    header.addEventListener('click', ()=>{ sublist.classList.toggle('hide'); });
    header.querySelector('.count-toggle').addEventListener('click', (ev)=>{ ev.stopPropagation(); sublist.classList.toggle('hide'); });

    sublist.querySelectorAll('.subitem').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const name = btn.getAttribute('data-name');
        const rateText = btn.getAttribute('data-rate');
        const rate = parseRate(rateText);
        const payout = (btn.getAttribute('data-payout') || '0.5,0.3,0.2').split(',').map(parseFloat);
        const card = buildCard({name, rate, payout});
        cardHost.innerHTML = '';
        cardHost.appendChild(card);
        if(sublist.classList.contains('hide')){ sublist.classList.remove('hide'); }
      });
    });
    app.appendChild(wrap);
  });
}
render();
</script>

<script>
// Register SW (unchanged)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./service-worker.js', {scope: './'}).catch(()=>{});
  });
}
</script>

<style>
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;place-items:center;z-index:9999}
.modal{width:min(920px,96vw);max-height:90vh;overflow:auto;background:#0b1326;border:1px solid var(--line);border-radius:16px;padding:14px}
.modal h2{margin:6px 0 8px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:14px}
.table input[type="text"], .table input[type="number"]{width:100%;padding:8px;border-radius:8px;border:1px solid var(--line);background:#0a1428;color:#e2e8f0}
.small{font-size:12px;color:var(--muted)}
.tabbar{display:flex;gap:8px;margin:8px 0 12px}
.tabbar button{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0a1428;color:#e2e8f0;cursor:pointer}
.tabbar button.active{outline:2px solid #334155}
.badge{border:1px solid var(--line);padding:2px 6px;border-radius:999px;font-size:12px}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
hr.hr{border:0;border-top:1px solid var(--line);margin:10px 0}
</style>
<div id="modalAdmin" class="modal-backdrop">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>ç®¡ç†å¾Œå°</h2>
      <button id="adminClose" style="border:1px solid var(--line);background:#0a1428;color:#e2e8f0;border-radius:10px;padding:6px 10px;cursor:pointer">é—œé–‰</button>
    </div>
    <div class="tabbar">
      <button data-tab="products" class="active">å•†å“ç®¡ç†</button>
      <button data-tab="password">å¯†ç¢¼è¨­å®š</button>
      <button data-tab="settings">è¨­å®š</button>
    </div>
    <div id="adminGate" style="display:none;margin:8px 0 12px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#0a1428">
      <div class="small" style="margin-bottom:6px">è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ä»¥é€²å…¥å¾Œå°</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="gatePwd" type="password" placeholder="ç®¡ç†å¯†ç¢¼" style="flex:1;padding:8px;border-radius:8px;border:1px solid var(--line);background:#0b1326;color:#e2e8f0">
        <button id="gateLogin" style="padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0b1326;color:#e2e8f0;cursor:pointer">ç™»å…¥</button>
      </div>
    </div>
    <div id="tab-products">
      <div class="small">å¯èª¿æ•´æ¯”ç‡ã€åœç”¨å•†å“ï¼Œæˆ–æ–°å¢å•†å“ï¼ˆåƒ…å½±éŸ¿æœ¬è£ç½®ï¼›é‡æ–°æ•´ç†å¾Œä»ä¿ç•™ï¼‰ã€‚</div>
      <table class="table" id="adminTable">
        <thead><tr><th>ç¾¤çµ„</th><th>å•†å“åç¨±</th><th>æ¯”ç‡</th><th>ç™¼æ”¾</th><th>å•Ÿç”¨</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="actions">
        <button id="btnAddRow">æ–°å¢ä¸€åˆ—</button>
        <button id="btnSave">å„²å­˜</button>
      </div>
    </div>
    <div id="tab-password" style="display:none">
      <div class="small">é è¨­å¯†ç¢¼ï¼š<code>admin123</code>ï¼ˆä¸é¡¯ç¤ºåœ¨é é¢ï¼Œåƒ…æ­¤è™•æç¤ºï¼‰ã€‚</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <input id="oldPwd" type="password" placeholder="èˆŠå¯†ç¢¼">
        <input id="newPwd" type="password" placeholder="æ–°å¯†ç¢¼">
      </div>
      <div class="actions"><button id="btnChangePwd">ä¿®æ”¹å¯†ç¢¼</button></div>
    </div>
    <div id="tab-settings" style="display:none">
      <div class="small">é ç«¯ç€è¦½çµ±è¨ˆ APIï¼ˆä¾‹å¦‚ Google Apps Script éƒ¨ç½²ç¶²å€ï¼‰ã€‚</div>
      <input id="counterUrl" type="text" placeholder="https://script.google.com/macros/s/XXXX/exec" />
      <div class="small" style="margin-top:6px">èªªæ˜ï¼šæ¯æ¬¡é–‹å•Ÿé é¢æœƒé€å‡º <code>POST {"op":"hit"}</code>ï¼Œé æœŸå›å‚³ <code>{ "total": 123, "updatedAt": "2025-10-20T21:00:00+08:00" }</code>ã€‚è‹¥ç„¡ <code>updatedAt</code> æœƒé¡¯ç¤ºæœ¬æ©Ÿæ™‚é–“ã€‚</div>
      <div class="actions"><button id="btnSaveSettings">å„²å­˜è¨­å®š</button></div>
      <hr class="hr">
      <div class="small">é ç«¯è¨­å®šåŒæ­¥ APIï¼ˆå¯ç”¨ Google Apps Script æˆ–ä»»ä¸€ç°¡æ˜“å¾Œç«¯ï¼‰ã€‚</div>
      <input id="remoteCfgUrl" type="text" placeholder="https://script.google.com/macros/s/XXXX/exec" />
      <div class="small" style="margin-top:6px">
        è¦æ ¼ï¼š
        <ul style="margin:6px 0 0 18px; padding:0;">
          <li>æ¨é€ï¼š<code>POST {"op":"save","version":&lt;number&gt;,"cfg":&lt;object&gt;}</code> å›å‚³ <code>{ "ok": true }</code></li>
          <li>æ‹‰å–ï¼š<code>GET ?op=get</code> å›å‚³ <code>{ "version": &lt;number&gt;, "cfg": &lt;object&gt; }</code></li>
        </ul>
        è‹¥æœªè¨­å®šæ­¤æ¬„ä½ï¼Œå‰‡ç¶­æŒæœ¬æ©Ÿï¼ˆå–®æ©Ÿï¼‰è¨­å®šï¼Œä¸å½±éŸ¿åŸåŠŸèƒ½ã€‚
      </div>
    </div>
  </div>
</div>
<script>
// ====== Simple tab/show helpers ======
function showTab(id){
  document.querySelectorAll('.tabbar button').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  document.querySelectorAll('[id^="tab-"]').forEach(el=>el.style.display = (el.id === 'tab-'+id ? '' : 'none'));
}
function openAdmin(){
  const modal = document.getElementById('modalAdmin');
  const gate = document.getElementById('adminGate');
  const tabs = document.querySelector('.tabbar');
  const products = document.getElementById('tab-products');
  const password = document.getElementById('tab-password');
  const settings = document.getElementById('tab-settings');
  if(!window.__adminAuthed){
    gate.style.display = '';
    tabs.style.display = 'none';
    products.style.display = 'none';
    password.style.display = 'none';
    settings.style.display = 'none';
  }else{
    gate.style.display = 'none';
    tabs.style.display = '';
    products.style.display = '';
    password.style.display = 'none';
    settings.style.display = 'none';
    showTab('products');
  }
  buildAdminRows();
  modal.style.display = 'grid';
}
function closeAdmin(){
  const modal = document.getElementById('modalAdmin');
  modal.style.display = 'none';
  // FIX #3: reset session so reopening requires password (and new pwd is enforced)
  window.__adminAuthed = false;
}
document.getElementById('btnAdmin').addEventListener('click', openAdmin);
document.getElementById('adminClose').addEventListener('click', closeAdmin);
document.getElementById('modalAdmin').addEventListener('click', function(e){ if(e.target.id==='modalAdmin') closeAdmin(); });
document.addEventListener('keydown', function(e){ if(e.key==='Escape' && document.getElementById('modalAdmin').style.display!=='none') closeAdmin(); });

document.querySelectorAll('.tabbar button').forEach(b=>{
  b.addEventListener('click', ()=> showTab(b.dataset.tab));
});

// ===== Admin login =====
document.getElementById('gateLogin').addEventListener('click', ()=>{
  const v = (document.getElementById('gatePwd').value||'').trim();
  if(v !== getPwd()){ alert('å¯†ç¢¼éŒ¯èª¤'); return; }
  window.__adminAuthed = true;
  document.getElementById('adminGate').style.display = 'none';
  document.querySelector('.tabbar').style.display = '';
  showTab('products');
  document.getElementById('tab-products').style.display = '';
  document.getElementById('tab-password').style.display = 'none';
  document.getElementById('tab-settings').style.display = 'none';
});

// ===== Admin table build / read / save =====
function toPayoutString(p){ if(!p) return ''; if(Array.isArray(p)) return p.join(','); if(typeof p==='string') return p; return ''; }
function mergedGroupsForAdmin(){
  const defaults = GROUPS;
  let custom = {groups:[]};
  try{ custom = JSON.parse(localStorage.getItem(CFG_KEY)||'{"groups":[]}'); }catch(e){}
  const map = new Map();
  defaults.forEach(g=>{
    const clone = { key: g.key, sub: g.sub || '', items: [] };
    (g.items||[]).forEach(it=>{
      clone.items.push({ name: it.name||'', rate: it.rate||'', payout: toPayoutString(it.payout), enabled: (it.enabled!==false) });
    });
    map.set(g.key, clone);
  });
  (custom.groups||[]).forEach(cg=>{
    let base = map.get(cg.key);
    if(!base){ base = { key: cg.key, sub: '', items: [] }; map.set(cg.key, base); }
    const dict = new Map((base.items||[]).map(i=>[i.name, i]));
    (cg.items||[]).forEach(ci=>{
      const ex = dict.get(ci.name) || { name: ci.name||'', rate:'', payout:'', enabled:true };
      dict.set(ci.name, {
        name: ci.name || ex.name,
        rate: (ci.rate!==undefined && ci.rate!==null && ci.rate!=='') ? ci.rate : ex.rate,
        payout: (ci.payout!==undefined && ci.payout!==null && ci.payout!=='') ? (Array.isArray(ci.payout)?ci.payout.join(','):ci.payout) : ex.payout,
        enabled: (typeof ci.enabled==='boolean') ? ci.enabled : ex.enabled
      });
    });
    base.items = Array.from(dict.values());
  });
  return Array.from(map.values());
}
function buildAdminRows(){
  const tbody = document.querySelector('#adminTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const groups = mergedGroupsForAdmin();
  groups.forEach(g=>{
    (g.items||[]).forEach(it=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${g.key||''}" class="adm-group"></td>
        <td><input type="text" value="${it.name||''}" class="adm-name"></td>
        <td><input type="text" value="${it.rate||''}" class="adm-rate" placeholder="8.8% æˆ– 0.088"></td>
        <td><input type="text" value="${toPayoutString(it.payout)||''}" class="adm-payout" placeholder="0.5,0.3,0.2"></td>
        <td><input type="checkbox" class="adm-enabled" ${it.enabled!==false?'checked':''}></td>
        <td><button class="adm-del">åˆªé™¤</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
}
function readAdminRows(){
  const rows = Array.from(document.querySelectorAll('#adminTable tbody tr'));
  const tmp = {};
  rows.forEach(r=>{
    const key = (r.querySelector('.adm-group')?.value || 'æœªåˆ†é¡').trim();
    const name = (r.querySelector('.adm-name')?.value || '').trim();
    if(!name) return;
    const rate = (r.querySelector('.adm-rate')?.value || '').trim();
    const payout = (r.querySelector('.adm-payout')?.value || '').trim();
    let enabled = !!(r.querySelector('.adm-enabled')?.checked);
    if(r.dataset.deleted === '1'){ enabled = false; }
    (tmp[key] = tmp[key] || []).push({name, rate, payout, enabled});
  });
  return {groups: Object.entries(tmp).map(([key, items])=>({key, items}))};
}

document.getElementById('btnAddRow').addEventListener('click', ()=>{
  const tb = document.querySelector('#adminTable tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = '<td><input class="adm-group" type="text" placeholder="ç¾¤çµ„"></td><td><input class="adm-name" type="text" placeholder="å•†å“åç¨±"></td><td><input class="adm-rate" type="text" placeholder="8.8%"></td><td><input class="adm-payout" type="text" placeholder="0.5,0.3,0.2"></td><td><input class="adm-enabled" type="checkbox" checked></td><td><button class="adm-del">åˆªé™¤</button></td>';
  tb.appendChild(tr);
});

document.addEventListener('click', function(e){
  const t = e.target;
  if(t && t.classList && t.classList.contains('adm-del')){
    e.preventDefault();
    const tr = t.closest('tr'); if(!tr) return;
    tr.dataset.deleted = '1';
    tr.style.opacity = '0.5';
    const en = tr.querySelector('.adm-enabled');
    if(en) en.checked = false;
    const nameInput = tr.querySelector('.adm-name');
    if(nameInput){ nameInput.style.textDecoration = 'line-through'; }
    t.textContent = 'å·²åˆªé™¤';
    t.disabled = true;
  }
}, true);

document.getElementById('btnSave').addEventListener('click', ()=>{
  const cfg = readAdminRows();
  saveCustom(cfg);
  alert('å·²å„²å­˜ã€‚é‡æ–°æ•´ç†ä»¥å¥—ç”¨ã€‚');
  render(); // ç«‹å³å¥—ç”¨åˆ°å‰å°ï¼ˆä¸å¿…ç­‰é‡æ•´ï¼‰
  // å°æ‰€æœ‰è£ç½®æ¨é€
  syncPush();
});

// ===== Password change (enforce re-login with new password) =====
document.getElementById('btnChangePwd').addEventListener('click', ()=>{
  const oldPwd = (document.getElementById('oldPwd').value||'').trim();
  const newPwd = (document.getElementById('newPwd').value||'').trim();
  if(oldPwd !== getPwd()){ alert('èˆŠå¯†ç¢¼éŒ¯èª¤'); return; }
  if(newPwd.length < 4){ alert('æ–°å¯†ç¢¼è‡³å°‘ 4 ç¢¼'); return; }
  setPwd(newPwd);
  // FIX #3: force logout so reopening admin requires the new password
  window.__adminAuthed = false;
  alert('å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹ä»¥æ–°å¯†ç¢¼é‡æ–°ç™»å…¥å¾Œå°ã€‚');
  closeAdmin();
});


// ===== Settings: remote cfg sync URL =====
(function(){
  const urlInput = document.getElementById('remoteCfgUrl');
  if(urlInput){ urlInput.value = localStorage.getItem(REMOTE_CFG_URL_KEY) || ''; }
  const saveBtn = document.getElementById('btnSaveSettings');
  if(saveBtn){
    saveBtn.addEventListener('click', ()=>{
      const remote = (document.getElementById('remoteCfgUrl').value||'').trim();
      if(remote && !/^https?:\/\//.test(remote)){ alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é ç«¯è¨­å®š URL'); return; }
      if(remote){ localStorage.setItem(REMOTE_CFG_URL_KEY, remote); }
      else{ localStorage.removeItem(REMOTE_CFG_URL_KEY); }
      alert('å·²å„²å­˜é ç«¯è¨­å®š URL');
      // ç«‹å³å˜—è©¦æ‹‰å–ä¸€æ¬¡ï¼ˆè‹¥æœ‰è¨­å®šï¼‰
      syncPull().catch(()=>{});
    });
  }
})();

// ===== Remote sync helpers (multi-device) =====
async function syncPush(){
  const url = localStorage.getItem(REMOTE_CFG_URL_KEY);
  if(!url) return;
  const cfg = loadCustom();
  const version = Date.now(); // å–®èª¿éå¢ç‰ˆæœ¬
  localStorage.setItem(CFG_VERSION_KEY, String(version));
  try{
    await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({op:'save', version, cfg})
    });
  }catch(e){
    console.warn('syncPush failed', e);
  }
}
async function syncPull(){
  const url = localStorage.getItem(REMOTE_CFG_URL_KEY);
  if(!url) return;
  try{
    const resp = await fetch(url + (url.includes('?') ? '&' : '?') + 'op=get', { cache: 'no-store' });
    if(!resp.ok) return;
    const data = await resp.json().catch(()=>null);
    if(!data || typeof data.version==='undefined' || !data.cfg) return;
    const localVer = +(localStorage.getItem(CFG_VERSION_KEY) || 0);
    if(data.version > localVer){
      saveCustom(data.cfg);
      localStorage.setItem(CFG_VERSION_KEY, String(data.version));
      render();
    }
  }catch(e){
    console.warn('syncPull failed', e);
  }
}
// å•Ÿå‹•æ™‚èˆ‡èšç„¦æ™‚è‡ªå‹•æ‹‰å–ï¼›æ¯ 60 ç§’è¼ªè©¢ä¸€æ¬¡
window.addEventListener('load', ()=>{ syncPull().catch(()=>{}); });
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState === 'visible'){ syncPull().catch(()=>{}); } });
setInterval(()=>{ syncPull().catch(()=>{}); }, 60000);

// ===== Settings: counter API =====
(function(){
  const urlInput = document.getElementById('counterUrl');
  if(urlInput){ urlInput.value = localStorage.getItem(COUNTER_URL_KEY) || ''; }
  document.getElementById('btnSaveSettings').addEventListener('click', ()=>{
    const url = (document.getElementById('counterUrl').value||'').trim();
    if(!/^https?:\/\//.test(url)){ alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ URL'); return; }
    localStorage.setItem(COUNTER_URL_KEY, url);
    alert('å·²å„²å­˜ API ä½å€');
    updateCounter();
  });
})();

// ===== Counter: POST {op:'hit'} then render ======
async function updateCounter(){
  const url = localStorage.getItem(COUNTER_URL_KEY);
  const totalEl = document.getElementById('visitTotal');
  const updWrap = document.getElementById('visitUpdatedWrap');
  const updEl = document.getElementById('visitUpdated');
  if(!url){ totalEl.textContent = 'æœªè¨­å®š'; return; }
  try{
    const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({op:'hit'}) });
    const data = await resp.json().catch(()=>({}));
    const total = (data && typeof data.total!=='undefined') ? data.total : null;
    if(total===null){ totalEl.textContent = 'â€”'; } else { totalEl.textContent = String(total); }
    let upd = data && data.updatedAt;
    if(!upd){ upd = new Date().toISOString(); }
    const dt = new Date(upd);
    const fmt = (n)=> String(n).padStart(2,'0');
    const local = `${dt.getFullYear()}-${fmt(dt.getMonth()+1)}-${fmt(dt.getDate())} ${fmt(dt.getHours())}:${fmt(dt.getMinutes())}`;
    updEl.textContent = local;
    updWrap.style.display = '';
  }catch(e){
    totalEl.textContent = 'é€£ç·šå¤±æ•—';
  }
}
updateCounter();
</script>


<!-- Live Sync (Long-Poll) - inserted by helper -->
<script>
// ==== Remote Live Sync (long-poll) ====
let __liveAbort = null;

function stopLiveSync() {
  try { if (__liveAbort) { __liveAbort.abort(); } } catch(e) {}
  __liveAbort = null;
}

async function startLiveSync() {
  try {
    const url = localStorage.getItem(typeof REMOTE_CFG_URL_KEY !== 'undefined' ? REMOTE_CFG_URL_KEY : 'remoteCfgURL_v114_10_20');
    if (!url) return;

    stopLiveSync();
    let latest = +(localStorage.getItem(typeof CFG_VERSION_KEY !== 'undefined' ? CFG_VERSION_KEY : 'customProductsVersion_v114_10_20') || 0);

    while (true) {
      try {
        __liveAbort = new AbortController();
        const waitUrl = url + (url.includes('?') ? '&' : '?') + 'op=wait&since=' + latest;
        const resp = await fetch(waitUrl, { signal: __liveAbort.signal, cache: 'no-store' });
        if (!resp.ok) throw new Error('wait failed');
        const data = await resp.json().catch(()=>null);
        if (data && typeof data.version === 'number' && data.version > latest) {
          latest = data.version;
          localStorage.setItem(typeof CFG_VERSION_KEY !== 'undefined' ? CFG_VERSION_KEY : 'customProductsVersion_v114_10_20', String(latest));
          if (typeof syncPull === 'function') {
            await syncPull(); // æ‹‰å–ä¸¦é‡æ–° render()
          }
        }
        // ç«‹åˆ»é€²ä¸‹ä¸€è¼ªé•·è¼ªè©¢
      } catch (err) {
        // é€£ç·šå¤±æ•—/ä¸­æ–·ï¼Œ3 ç§’å¾Œé‡è©¦
        await new Promise(r => setTimeout(r, 3000));
      }
    }
  } catch(e) {
    // è‹¥ç™¼ç”Ÿä¸å¯é æœŸéŒ¯èª¤ï¼Œé¿å…æ•´é å´©æ½°
    console.warn('startLiveSync error', e);
  }
}

// ---- äº‹ä»¶æ›è¼‰ï¼šé é¢è¼‰å…¥èˆ‡ã€Œå„²å­˜è¨­å®šã€å¾Œï¼Œç¢ºä¿ Live Sync å•Ÿå‹• ----
window.addEventListener('load', function(){
  try { if (typeof startLiveSync === 'function') startLiveSync(); } catch(e){}
});

// å¾Œå°ã€Œå„²å­˜è¨­å®šã€æŒ‰éˆ•ï¼ˆid=btnSaveSettingsï¼‰é»æ“Šå¾Œï¼Œé‡å•Ÿ Live Sync
document.addEventListener('DOMContentLoaded', function(){
  try {
    var btn = document.getElementById('btnSaveSettings');
    if (btn) {
      btn.addEventListener('click', function(){
        try { if (typeof stopLiveSync === 'function') stopLiveSync(); } catch(e){}
        try { if (typeof startLiveSync === 'function') startLiveSync(); } catch(e){}
      });
    }
  } catch(e){}
});
</script>

</body>
</html>